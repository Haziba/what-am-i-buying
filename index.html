<div class="sideBasketContents" id="yui_3_13_0_1_1503257290745_1261" style="height: 225px;"><ul id="Active-Active-Default" class="shelf"><li id="tr-254925029" data-product-id="254925029" class="product"><div class="basketRowThumbnail clearfix"><a class="productDetailsLink" href="https://www.tesco.com/groceries/product/details/?id=254925029" title="View full product details"><img id="basket_product_254925029" alt="" width="45" height="45" src="https://img.tesco.com/Groceries/pi/994/5000137121994/IDShot_45x45.jpg"><span class="hide">Product</span><span class="productTitle" data-title="true">Jacobs Cream Crackers 300G</span></a><a class="remove basketButton" data-product-id="254925029" title="Delete Jacobs Cream Crackers 300G from basket" href="https://www.tesco.com/groceries/product/browse/default.aspx?N=4293160158&amp;Ne=4294793660&amp;action=Remove_698&amp;ProductId=254925029"><img src="https://ui.tescoassets.com/groceries/UIAssets/I/../Compressed/I_636325080739007250/Sites/Retail/Superstore/Online/Mercury/Icons/IncrementIcons/22x22/icon-x-blue-small.png" alt="Remove"></a></div><div class="basketRowPriceQuantity clearfix"><div class="itemQuantity"><a class="bd basketButton decreaseAmount" data-product-id="254925029" href="https://www.tesco.com/groceries/product/browse/default.aspx?N=4293160158&amp;Ne=4294793660&amp;action=IncreaseDecrease_698&amp;ProductId=254925029&amp;qty=-1"><img src="https://ui.tescoassets.com/groceries/UIAssets/I/../Compressed/I_636325080739007250/Sites/Retail/Superstore/Online/Mercury/Icons/IncrementIcons/22x22/icon-minus-blue-small.png" alt="Decrease quantity"></a><p class="bq basketItemQuantity">1</p><a class="bi basketButton increaseAmount" data-product-id="254925029" href="https://www.tesco.com/groceries/product/browse/default.aspx?N=4293160158&amp;Ne=4294793660&amp;action=IncreaseDecrease_698&amp;ProductId=254925029&amp;qty=1"><img src="https://ui.tescoassets.com/groceries/UIAssets/I/../Compressed/I_636325080739007250/Sites/Retail/Superstore/Online/Mercury/Icons/IncrementIcons/22x22/icon-plus-blue-small.png" alt="Increase quantity"></a></div><p class="price"><span class="linePrice" title=" (£0.32/100g)">£0.97</span></p></div></li><li id="tr-252004443" data-product-id="252004443" class="product"><div class="basketRowThumbnail clearfix"><a class="productDetailsLink" href="https://www.tesco.com/groceries/product/details/?id=252004443" title="View full product details"><img id="basket_product_252004443" alt="" width="45" height="45" src="https://img.tesco.com/Groceries/pi/886/5000157024886/IDShot_45x45.jpg"><span class="hide">Product</span><span class="productTitle" data-title="true">Heinz Baked Beans In Tomato Sauce 4 X415g</span></a><a class="remove basketButton" data-product-id="252004443" title="Delete Heinz Baked Beans In Tomato Sauce 4 X415g from basket" href="https://www.tesco.com/groceries/product/browse/default.aspx?N=4293160158&amp;Ne=4294793660&amp;action=Remove_698&amp;ProductId=252004443"><img src="https://ui.tescoassets.com/groceries/UIAssets/I/../Compressed/I_636325080739007250/Sites/Retail/Superstore/Online/Mercury/Icons/IncrementIcons/22x22/icon-x-blue-small.png" alt="Remove"></a></div><div class="basketRowPriceQuantity clearfix"><div class="itemQuantity"><a class="bd basketButton decreaseAmount" data-product-id="252004443" href="https://www.tesco.com/groceries/product/browse/default.aspx?N=4293160158&amp;Ne=4294793660&amp;action=IncreaseDecrease_698&amp;ProductId=252004443&amp;qty=-1"><img src="https://ui.tescoassets.com/groceries/UIAssets/I/../Compressed/I_636325080739007250/Sites/Retail/Superstore/Online/Mercury/Icons/IncrementIcons/22x22/icon-minus-blue-small.png" alt="Decrease quantity"></a><p class="bq basketItemQuantity">1</p><a class="bi basketButton increaseAmount" data-product-id="252004443" href="https://www.tesco.com/groceries/product/browse/default.aspx?N=4293160158&amp;Ne=4294793660&amp;action=IncreaseDecrease_698&amp;ProductId=252004443&amp;qty=1"><img src="https://ui.tescoassets.com/groceries/UIAssets/I/../Compressed/I_636325080739007250/Sites/Retail/Superstore/Online/Mercury/Icons/IncrementIcons/22x22/icon-plus-blue-small.png" alt="Increase quantity"></a></div><p class="price"><span class="linePrice" title=" (£1.63/kg)">£2.69</span></p></div></li><li id="tr-297373132" data-product-id="297373132" class="product"><div class="basketRowThumbnail clearfix"><a class="productDetailsLink" href="https://www.tesco.com/groceries/product/details/?id=297373132" title="View full product details"><img id="basket_product_297373132" alt="" width="45" height="45" src="https://img.tesco.com/Groceries/pi/514/5000159501514/IDShot_45x45.jpg"><span class="hide">Product</span><span class="productTitle" data-title="true">Celebrations Tub 680G</span></a><a class="remove basketButton" data-product-id="297373132" title="Delete Celebrations Tub 680G from basket" href="https://www.tesco.com/groceries/product/browse/default.aspx?N=4293160158&amp;Ne=4294793660&amp;action=Remove_698&amp;ProductId=297373132"><img src="https://ui.tescoassets.com/groceries/UIAssets/I/../Compressed/I_636325080739007250/Sites/Retail/Superstore/Online/Mercury/Icons/IncrementIcons/22x22/icon-x-blue-small.png" alt="Remove"></a></div><div class="basketRowPriceQuantity clearfix"><div class="itemQuantity"><a class="bd basketButton decreaseAmount" data-product-id="297373132" href="https://www.tesco.com/groceries/product/browse/default.aspx?N=4293160158&amp;Ne=4294793660&amp;action=IncreaseDecrease_698&amp;ProductId=297373132&amp;qty=-1"><img src="https://ui.tescoassets.com/groceries/UIAssets/I/../Compressed/I_636325080739007250/Sites/Retail/Superstore/Online/Mercury/Icons/IncrementIcons/22x22/icon-minus-blue-small.png" alt="Decrease quantity"></a><p class="bq basketItemQuantity">1</p><a class="bi basketButton increaseAmount" data-product-id="297373132" href="https://www.tesco.com/groceries/product/browse/default.aspx?N=4293160158&amp;Ne=4294793660&amp;action=IncreaseDecrease_698&amp;ProductId=297373132&amp;qty=1"><img src="https://ui.tescoassets.com/groceries/UIAssets/I/../Compressed/I_636325080739007250/Sites/Retail/Superstore/Online/Mercury/Icons/IncrementIcons/22x22/icon-plus-blue-small.png" alt="Increase quantity"></a></div><p class="price"><span class="linePrice" title=" (£0.74/100g)">£5.00</span></p></div></li><li id="tr-292284222" data-product-id="292284222" class="product"><div class="basketRowThumbnail clearfix"><a class="productDetailsLink" href="https://www.tesco.com/groceries/product/details/?id=292284222" title="View full product details"><img id="basket_product_292284222" alt="" width="45" height="45" src="https://img.tesco.com/Groceries/pi/283/5054775750283/IDShot_45x45.jpg"><span class="hide">Product</span><span class="productTitle" data-title="true">Tesco British Chicken Breast Portions 950G</span></a><a class="remove basketButton" data-product-id="292284222" title="Delete Tesco British Chicken Breast Portions 950G from basket" href="https://www.tesco.com/groceries/product/browse/default.aspx?N=4293160158&amp;Ne=4294793660&amp;action=Remove_698&amp;ProductId=292284222"><img src="https://ui.tescoassets.com/groceries/UIAssets/I/../Compressed/I_636325080739007250/Sites/Retail/Superstore/Online/Mercury/Icons/IncrementIcons/22x22/icon-x-blue-small.png" alt="Remove"></a><p class="basketInfo" id="promoReward-292284222">You have qualified for Save 50p Was £5.50 Now £5.00</p></div><div class="basketRowPriceQuantity clearfix"><div class="itemQuantity"><a class="bd basketButton decreaseAmount" data-product-id="292284222" href="https://www.tesco.com/groceries/product/browse/default.aspx?N=4293160158&amp;Ne=4294793660&amp;action=IncreaseDecrease_698&amp;ProductId=292284222&amp;qty=-1"><img src="https://ui.tescoassets.com/groceries/UIAssets/I/../Compressed/I_636325080739007250/Sites/Retail/Superstore/Online/Mercury/Icons/IncrementIcons/22x22/icon-minus-blue-small.png" alt="Decrease quantity"></a><p class="bq basketItemQuantity">1</p><a class="bi basketButton increaseAmount" data-product-id="292284222" href="https://www.tesco.com/groceries/product/browse/default.aspx?N=4293160158&amp;Ne=4294793660&amp;action=IncreaseDecrease_698&amp;ProductId=292284222&amp;qty=1"><img src="https://ui.tescoassets.com/groceries/UIAssets/I/../Compressed/I_636325080739007250/Sites/Retail/Superstore/Online/Mercury/Icons/IncrementIcons/22x22/icon-plus-blue-small.png" alt="Increase quantity"></a></div><p class="price"><span class="linePrice" title=" (£5.27/kg)">£5.00</span></p></div></li></ul></div><div class="sideBasketFooter"><ul><li class="substituteLink"><a id="substituteOptionsLink" class="substituteOptionsLink" href="https://www.tesco.com/groceries/basket/">Substitute options</a></li><li class="shopLink"><a class="saveBasketToShoppingListLink addBasketToListLink dialogLink" href="https://www.tesco.com/groceries/dialogue/default.aspx?dialogueName=AddItemsToShoppingList&amp;addbaskettolist=true">Save basket to Shopping list</a></li><li class="basketLink last"><a class="emptyBasketLink dialogLink" href="https://www.tesco.com/groceries/dialogue/default.aspx?dialogueName=EmptyBasket">Empty basket</a></li></ul></div></form></div></div></div>

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script>
  $(function(){
    var $lis = $(".sideBasketContents").find("li");
    var prods = {};

    for(var i = 0; i < $lis.length; i++)
      (function($li){
        prods[$($li).prop("id").split("-")[1]] = {
          $li: $($li)
        };
      })($lis[i]);

    $.get({
      url: "https://dev.tescolabs.com/product/?tpnc=" + Object.keys(prods).join("&tpnc="),
      headers: {"Ocp-Apim-Subscription-Key": "b30688fcf2524ba98bf8bdf982a8c882"}
    }, function(prodDetails){
      for(var prodDetailKey in prodDetails.products){
        var prodDetail = prodDetails.products[prodDetailKey];
        var prod = prods[prodDetail.tpnc];

        prod.detail = prodDetail;
        prod.rating = handleProduct(prodDetail);

        for(var ratingKey in prod.rating){
          if(prod.rating[ratingKey])
            prod.$li.find(".productDetailsLink").after($("<div/>").text(ratingKey).addClass("rating certainty-" + prod.rating[ratingKey]));
        }

        console.log(prods);
      }
    });
  });

  var handleProduct = function(prod){
    var product = {
      vegan: Certainty.Amber,
      vegetarian: Certainty.Amber
    };

    product.vegan = isVegan(prod);
    product.vegetarian = isVegetarian(prod);

    return product;
  };

  var nonVegetarianIngredients = ["chicken breast"];
  var nonVeganIngredients = nonVegetarianIngredients.concat(["cheese"]);

  var isVegetarian = function(prod){
    var lifestyleAttributes = prod.productAttributes[0].category[0].lifestyle;

    if(lifestyleAttributes){
      for(var i = 0; i < lifestyleAttributes.length; i++){
        if(lifestyleAttributes[i].lifestyle.value.toLowerCase() == "suitable for vegetarians")
          return Certainty.Green;
      }
    }

    return Certainty.Amber;
  }

  var isVegan = function(prod){
    var ingredients = prod.ingredients;

    if(ingredients){
      for(var i = 0; i < ingredients.length; i++){
        var certainty = certaintyOfMatch(ingredients[i], nonVeganIngredients);
        if(certainty){
            return certainty;
        }
      }
    }

    if(prod.description){
      var certainty = certaintyOfMatch(prod.description, nonVeganIngredients);
      if(certainty){
        return certainty;
      }
    }

    return Certainty.Amber;
  }

  var certaintyOfMatch = function(string, dangers){
    if(dangers.indexOf(string.toLowerCase()) > 0){
      return Certainty.Red;
    }
    if(dangers.filter(function(a) { return string.toLowerCase().includes(a); })){
      return Certainty.Amber;
    }
  }

  var Certainty = {
    Green: 1,
    Amber: 2,
    Red: 3
  };
</script>

<style>
  .rating {
    padding: 3px;
    display: inline;
    text-transform: capitalize;
  }

  .rating.certainty-1 {
    background-color: green;
    color: white;
  }

  .rating.certainty-2 {
    background-color: yellow;
    color: black;
  }

  .rating.certainty-3 {
    background-color: red;
    color: white;
  }
</style>
